on:
  push:
    branches: [ master ]
  pull_request:
jobs:
  windows:
    runs-on: windows-2016
    steps:
      - uses: actions/checkout@v2
      - name: Install
        shell: cmd
        run: |
          curl -LO https://files.salome-platform.org/Salome/Salome9.7.0/SALOME-9.7.0.zip
          mkdir C:\work
          7z x SALOME-9.7.0.zip -oC:\work > nul
          dir /p C:\work\SALOME-9.7.0\W64

          git clone --depth 1 https://github.com/madler/zlib.git
          cmake -LAH -S zlib -G "Visual Studio 15 2017 Win64" -DCMAKE_INSTALL_PREFIX="C:/work/SALOME-9.7.0/W64/zlib" && cmake --build . --config Release --target install

          git clone --depth 1 https://gitlab.com/federicomenaquintero/bzip2.git
          del CMakeCache.txt
          cmake -LAH -S bzip2 -G "Visual Studio 15 2017 Win64" -DCMAKE_INSTALL_PREFIX="C:/work/SALOME-9.7.0/W64/bzip2" && cmake --build . --config Release --target install

          curl -LO https://github.com/nih-at/libzip/archive/refs/tags/v1.8.0.zip
          7z x v1.8.0.zip -oC:\work > nul
          del CMakeCache.txt
          cmake -LAH -S C:/work/libzip-1.8.0 -G "Visual Studio 15 2017 Win64" -DCMAKE_INSTALL_PREFIX=C:/work/SALOME-9.7.0/W64/libzip -DZLIB_LIBRARY=C:/work/SALOME-9.7.0/W64/zlib/lib/zlib.lib -DZLIB_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/zlib/include -DBZIP2_LIBRARIES=C:/work/SALOME-9.7.0/W64/bzip2/lib/bz2.lib -DBZIP2_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/bzip2/include -DENABLE_BZIP2=OFF && cmake --build . --config Release --target install

          curl -LO https://github.com/zlib-ng/minizip-ng/archive/refs/tags/3.0.4.zip
          7z x 3.0.4.zip
          del CMakeCache.txt
          cmake -LAH -S minizip-ng-3.0.4 -G "Visual Studio 15 2017 Win64" -DCMAKE_INSTALL_PREFIX=C:/work/SALOME-9.7.0/W64/minizip -DBZIP2_LIBRARY=C:/work/SALOME-9.7.0/W64/bzip2/lib/bz2.lib -DBZIP2_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/bzip2/include -DMZ_LZMA=OFF -DZLIB_LIBRARY=C:/work/SALOME-9.7.0/W64/zlib/lib/zlib.lib -DZLIB_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/zlib/include && cmake --build . --config Release --target install
          
          git clone https://github.com/robotology-dependencies/libxml2-cmake-buildsystem.git
          del CMakeCache.txt
          cmake -LAH -S libxml2-cmake-buildsystem -G "Visual Studio 15 2017 Win64" -DCMAKE_INSTALL_PREFIX=C:/work/SALOME-9.7.0/W64/libxml2 -DZLIB_LIBRARY=C:/work/SALOME-9.7.0/W64/zlib/lib/zlib.lib -DZLIB_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/zlib/include -DLIBXML2_WITH_LZMA=OFF -DWITH_LZMA=OFF -DLIBXML2_WITH_ICONV=OFF -DWITH_ICONV=OFF && cmake --build . --config Release --target install
          
          curl -LO https://github.com/libjpeg-turbo/libjpeg-turbo/archive/refs/tags/2.1.2.zip
          7z x 2.1.2.zip
          del CMakeCache.txt
          cmake -LAH -S libjpeg-turbo-2.1.2 -G "Visual Studio 15 2017 Win64" -DCMAKE_INSTALL_PREFIX=C:/work/SALOME-9.7.0/W64/jpeg && cmake --build . --config Release --target install

          curl -LO https://github.com/libgeos/geos/archive/refs/tags/3.9.2.zip
          7z x 3.9.2.zip -oC:\work > nul
          del CMakeCache.txt
          cmake -LAH -S "C:/work/geos-3.9.2" -G "Visual Studio 15 2017 Win64" -DCMAKE_INSTALL_PREFIX="C:/work/SALOME-9.7.0/W64/geos" -DBUILD_TESTING=OFF && cmake --build . --config Release --target install

          git clone --depth 1 https://github.com/jschueller/sqlite.git
          del CMakeCache.txt
          cmake -LAH -S sqlite -G "Visual Studio 15 2017 Win64" -DCMAKE_INSTALL_PREFIX="C:/work/SALOME-9.7.0/W64/sqlite" && cmake --build . --config Release --target install

          curl -LO https://github.com/OSGeo/PROJ/archive/refs/tags/8.0.1.zip
          7z x 8.0.1.zip -oC:\work > nul
          del CMakeCache.txt
          cmake -LAH -S "C:/work/proj-8.0.1" -G "Visual Studio 15 2017 Win64" -DCMAKE_INSTALL_PREFIX="C:/work/SALOME-9.7.0/W64/proj" -DBUILD_SHARED_LIBS=ON -DENABLE_TIFF=OFF -DENABLE_CURL=OFF -DBUILD_PROJSYNC=OFF -DBUILD_TESTING=OFF -DSQLITE3_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/sqlite/include -DSQLITE3_LIBRARY=C:/work/SALOME-9.7.0/W64/sqlite/lib/sqlite3.lib -DEXE_SQLITE3=C:/work/SALOME-9.7.0/W64/sqlite/bin/sqlite3 && cmake --build . --config Release --target install
          
          curl -LO https://github.com/OSGeo/gdal/archive/refs/tags/v3.3.1.zip
          7z x v3.3.1.zip
          git clone --depth 1 https://github.com/OSGeo/gdal.git
          del CMakeCache.txt
          cmake -LAH -S gdal -G "Visual Studio 15 2017 Win64" -DCMAKE_INSTALL_PREFIX="C:/work/SALOME-9.7.0/W64/gdal" -DPROJ_LIBRARY=C:/work/SALOME-9.7.0/W64/proj/lib/proj.lib -DPROJ_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/proj/include -DZLIB_LIBRARY=C:/work/SALOME-9.7.0/W64/zlib/lib/zlib.lib -DZLIB_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/zlib/include -DGDAL_USE_MYSQL=OFF -DGDAL_USE_SQLITE3=OFF -DGDAL_ENABLE_PLUGINS=OFF -DJPEG_LIBRARY=C:/work/SALOME-9.7.0/W64/jpeg/lib/jpeg.lib -DJPEG_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/jpeg/include -DRENAME_INTERNAL_LIBJPEG_SYMBOLS=OFF -DBUILD_APPS=OFF -DBUILD_CSHARP_BINDINGS=OFF -DBUILD_DOCS=OFF -DBUILD_JAVA_BINDINGS=OFF -DBUILD_PYTHON_BINDINGS=OFF -DBUILD_TESTING=OFF && cmake --build . --config Release --target install

          curl -LO https://github.com/protocolbuffers/protobuf/archive/refs/tags/v3.13.0.zip
          7z x v3.13.0.zip
          del CMakeCache.txt
          cmake -LAH -S protobuf-3.13.0/cmake -G "Visual Studio 15 2017 Win64" -DCMAKE_INSTALL_PREFIX=C:/work/SALOME-9.7.0/W64/protobuf -DZLIB_LIBRARY=C:/work/SALOME-9.7.0/W64/zlib/lib/zlib.lib -DZLIB_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/zlib/include -Dprotobuf_BUILD_TESTS=OFF && cmake --build . --config Release --target install

          echo call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" amd64
          echo nmake /HELP
          curl -LO http://www.gaia-gis.it/gaia-sins/libspatialite-5.0.1.zip
          7z x libspatialite-5.0.1.zip
          git clone --depth 1 https://github.com/jschueller/libspatialite.git
          del CMakeCache.txt
          cmake -LAH -S libspatialite -G "Visual Studio 15 2017 Win64" -DCMAKE_INSTALL_PREFIX=C:/work/SALOME-9.7.0/W64/spatiallite -DZLIB_LIBRARY=C:/work/SALOME-9.7.0/W64/zlib/lib/zlib.lib -DZLIB_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/zlib/include -DPROJ_LIBRARY=C:/work/SALOME-9.7.0/W64/proj/lib/proj.lib -DPROJ_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/proj/include -DGEOS_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/geos/include -DGEOS_LIBRARY=C:/work/SALOME-9.7.0/W64/geos/lib/geos.lib -DMINIZIP_LIBRARY=C:/work/SALOME-9.7.0/W64/proj/lib/libminizip.lib -DMINIZIP_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/minizip/include -DLIBXML2_LIBRARY=C:/work/SALOME-9.7.0/W64/libxml2/lib/xml.lib -DLIBXML2_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/libxml2/include/libxml2 && cmake --build . --config Release --target install
          
          curl -LO https://github.com/libspatialindex/libspatialindex/archive/refs/tags/1.9.3.zip
          7z x 1.9.3.zip
          del CMakeCache.txt
          cmake -LAH -S libspatialindex-1.9.3 -G "Visual Studio 15 2017 Win64" -DCMAKE_INSTALL_PREFIX=C:/work/SALOME-9.7.0/W64/spatialindex && cmake --build . --config Release --target install        

          curl -LO https://downloads.sourceforge.net/winflexbison/files/win_flex_bison3-latest.zip
          7z x win_flex_bison3-latest.zip

          curl -LO https://download.qt.io/archive/qt/5.12/5.12.10/submodules/qtbase-everywhere-src-5.12.10.zip
          7z x qtbase-everywhere-src-5.12.10.zip -oC:\work > nul

          curl -LO https://github.com/qgis/QGIS/archive/refs/tags/final-3_16_16.zip
          7z x final-3_16_16.zip -oC:\work > nul
          dir /p C:\work
          del CMakeCache.txt
          cmake -LAH -S "C:/work/QGIS-final-3_16_16" -G "Visual Studio 15 2017 Win64" -DCMAKE_INSTALL_PREFIX="C:/work/SALOME-9.7.0/W64/qgis" -DFLEX_EXECUTABLE=C:/work/win_flex.exe -DBISON_EXECUTABLE=C:/work/win_bison.exe -DGEOS_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/geos/include -DGEOS_LIBRARY=C:/work/SALOME-9.7.0/W64/geos/lib/geos.lib -DGDAL_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/gdal/include -DGDAL_LIBRARY=C:/work/SALOME-9.7.0/W64/gdal/lib/gdal.lib -DLIBZIP_LIBRARY=C:/work/SALOME-9.7.0/W64/libzip/lib/zip.lib -DLIBZIP_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/libzip/include -DLIBZIP_CONF_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/libzip/include -DProtobuf_LIBRARY=C:/work/SALOME-9.7.0/W64/protobuf/lib/libprotobuf.lib -DProtobuf_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/protobuf/include -DProtobuf_PROTOC_EXECUTABLE=C:/work/SALOME-9.7.0/W64/protobuf/bin/protoc -DSQLITE3_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/sqlite/include -DSQLITE3_LIBRARY=C:/work/SALOME-9.7.0/W64/sqlite/lib/sqlite3.lib -DZLIB_LIBRARY=C:/work/SALOME-9.7.0/W64/zlib/lib/zlib.lib -DZLIB_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/zlib/include -DPROJ_LIBRARY=C:/work/SALOME-9.7.0/W64/proj/lib/proj.lib -DPROJ_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/proj/include -DQt5_DIR=C:/work/SALOME-9.7.0/W64/qt/lib/cmake/Qt5 -DQWT_INCLUDE_DIR=C:/work/SALOME-9.7.0/W64/qwt/include -DQWT_LIBRARY=C:/work/SALOME-9.7.0/W64/qwt/lib/qwt.lib -DWITH_QTWEBKIT=FALSE -DWITH_GEOREFERENCER=FALSE -DWITH_3D=OFF -DWITH_BINDINGS=OFF -DWITH_SERVER=OFF -DWITH_CUSTOM_WIDGETS=OFF -DWITH_QUICK=OFF -DWITH_QGIS_PROCESS=OFF -DWITH_POSTGRESQL=OFF -DENABLE_TESTS=OFF -DWITH_QSPATIALITE=OFF && cmake --build . --config Release --target install

